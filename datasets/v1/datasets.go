// Package datasets provides a client for interacting with Tilebox Datasets.
//
// Documentation: https://docs.tilebox.com/datasets
package datasets // import "github.com/tilebox/tilebox-go/datasets/v1"

import (
	"context"
	"fmt"

	"github.com/google/uuid"
	"github.com/tilebox/tilebox-go/datasets/v1/field"
	datasetsv1 "github.com/tilebox/tilebox-go/protogen/datasets/v1"
	"google.golang.org/protobuf/types/descriptorpb"
)

// Dataset represents a Tilebox Dataset.
//
// Documentation: https://docs.tilebox.com/datasets/concepts/datasets
type Dataset struct {
	// ID is the unique identifier of the dataset.
	ID uuid.UUID
	// Type is the type of the dataset.
	Type *datasetsv1.AnnotatedType
	// Name is the name of the dataset.
	Name string
	// Description is a short description of the dataset.
	Description string
	// Slug is the unique slug of the dataset.
	Slug string
}

func (d Dataset) String() string {
	kind := ""
	switch d.Type.GetKind() {
	case datasetsv1.DatasetKind_DATASET_KIND_TEMPORAL:
		kind = "Temporal"
	case datasetsv1.DatasetKind_DATASET_KIND_SPATIOTEMPORAL:
		kind = "SpatioTemporal"
	case datasetsv1.DatasetKind_DATASET_KIND_UNSPECIFIED:
	}

	return fmt.Sprintf("%s [%s Dataset]: %s", d.Name, kind, d.Description)
}

type DatasetClient interface {
	// Create creates a new dataset.
	//
	// Documentation: https://docs.tilebox.com/guides/datasets/create
	Create(ctx context.Context, name string, kind DatasetKind, codeName string, description string, fields []*field.Descriptor) (*Dataset, error)

	// Get returns a dataset by its slug, e.g. "open_data.copernicus.sentinel1_sar".
	Get(ctx context.Context, slug string) (*Dataset, error)

	// List returns a list of all available datasets.
	List(ctx context.Context) ([]*Dataset, error)
}

var _ DatasetClient = &datasetClient{}

type datasetClient struct {
	service DatasetService
}

func pointer[T any](x T) *T {
	return &x
}

var timeField = datasetsv1.Field_builder{
	Descriptor: &descriptorpb.FieldDescriptorProto{
		Name:     pointer("time"),
		Label:    pointer(descriptorpb.FieldDescriptorProto_LABEL_OPTIONAL),
		Type:     pointer(descriptorpb.FieldDescriptorProto_TYPE_MESSAGE),
		TypeName: pointer(".google.protobuf.Timestamp"),
	},
	Annotation: datasetsv1.FieldAnnotation_builder{
		Description:  "The timestamp associated with each data point.",
		ExampleValue: "2022-10-17T14:35:28Z",
	}.Build(),
}.Build()

var idField = datasetsv1.Field_builder{
	Descriptor: &descriptorpb.FieldDescriptorProto{
		Name:     pointer("id"),
		Label:    pointer(descriptorpb.FieldDescriptorProto_LABEL_OPTIONAL),
		Type:     pointer(descriptorpb.FieldDescriptorProto_TYPE_MESSAGE),
		TypeName: pointer(".datasets.v1.UUID"),
	},
	Annotation: datasetsv1.FieldAnnotation_builder{
		Description:  "A universally unique identifier (UUID) that uniquely identifies each data point, automatically generated by Tilebox.",
		ExampleValue: "4e8a2836-72f8-4ac2-a9e9-cbe3492ef60c",
	}.Build(),
}.Build()

var ingestionTimeField = datasetsv1.Field_builder{
	Descriptor: &descriptorpb.FieldDescriptorProto{
		Name:     pointer("ingestion_time"),
		Label:    pointer(descriptorpb.FieldDescriptorProto_LABEL_OPTIONAL),
		Type:     pointer(descriptorpb.FieldDescriptorProto_TYPE_MESSAGE),
		TypeName: pointer(".google.protobuf.Timestamp"),
	},
	Annotation: datasetsv1.FieldAnnotation_builder{
		Description:  "The time the data point was ingested into the Tilebox API, automatically generated by Tilebox.",
		ExampleValue: "2022-10-17T14:35:28Z",
	}.Build(),
}.Build()

var geometryField = datasetsv1.Field_builder{
	Descriptor: &descriptorpb.FieldDescriptorProto{
		Name:     pointer("geometry"),
		Label:    pointer(descriptorpb.FieldDescriptorProto_LABEL_OPTIONAL),
		Type:     pointer(descriptorpb.FieldDescriptorProto_TYPE_MESSAGE),
		TypeName: pointer(".datasets.v1.Geometry"),
	},
	Annotation: datasetsv1.FieldAnnotation_builder{
		Description:  "The geometry associated with each data point.",
		ExampleValue: "POLYGON ((112.345 -36.789, ...))",
	}.Build(),
}.Build()

var requiredFieldsPerDatasetKind = map[DatasetKind][]*datasetsv1.Field{
	KindTemporal:       {timeField, idField, ingestionTimeField},
	KindSpatiotemporal: {timeField, idField, ingestionTimeField, geometryField},
}

// DatasetKind is the kind of dataset.
type DatasetKind int32

// DatasetKind values.
const (
	_                  DatasetKind = iota
	KindTemporal                   // A dataset that contains a timestamp field.
	KindSpatiotemporal             // A dataset that contains a timestamp field and a geometry field.
)

func (d datasetClient) Create(ctx context.Context, name string, kind DatasetKind, codeName string, description string, fields []*field.Descriptor) (*Dataset, error) {
	// make sure our dataset type contains all the fixed fields for the given kind
	requiredFields, ok := requiredFieldsPerDatasetKind[kind]
	if !ok {
		return nil, fmt.Errorf("unknown dataset kind: %d", kind)
	}

	datasetFields := make([]*datasetsv1.Field, 0, len(requiredFields))
	datasetFields = append(datasetFields, requiredFields...)
	for _, f := range fields {
		datasetFields = append(datasetFields, f.ToProto())
	}

	datasetType := datasetsv1.DatasetType_builder{
		Kind:   datasetsv1.DatasetKind(kind),
		Fields: datasetFields,
	}.Build()

	response, err := d.service.CreateDataset(ctx, name, datasetType, description, codeName)
	if err != nil {
		return nil, err
	}

	return protoToDataset(response), nil
}

func (d datasetClient) Get(ctx context.Context, slug string) (*Dataset, error) {
	response, err := d.service.GetDataset(ctx, slug)
	if err != nil {
		return nil, err
	}

	return protoToDataset(response), nil
}

func (d datasetClient) List(ctx context.Context) ([]*Dataset, error) {
	response, err := d.service.ListDatasets(ctx)
	if err != nil {
		return nil, err
	}

	datasets := make([]*Dataset, len(response.GetDatasets()))
	for i, datasetMessage := range response.GetDatasets() {
		datasets[i] = protoToDataset(datasetMessage)
	}

	return datasets, nil
}

func protoToDataset(d *datasetsv1.Dataset) *Dataset {
	return &Dataset{
		ID:          d.GetId().AsUUID(),
		Type:        d.GetType(),
		Name:        d.GetName(),
		Description: d.GetSummary(),
		Slug:        d.GetSlug(),
	}
}
